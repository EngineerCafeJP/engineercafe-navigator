# コードレビューガイド

## 概要

このガイドは、LangGraph移行プロジェクトにおけるコードレビューのプロセスと基準を定義します。

## レビュープロセス

### 1. PR作成

1. featureブランチをpush
2. GitHubでPRを作成
   - base: `develop`
   - compare: `feature/{agent-name}`
3. レビュアーを指定
   - 統合エージェント担当者（必須）
   - 担当エージェントの他の担当者（推奨）

### 2. レビュー前の自己チェック

PR作成者は以下のチェックリストを確認：

- [ ] コードがBlackでフォーマットされている
- [ ] Ruffのリンターエラーがない
- [ ] mypyの型チェックが通過している
- [ ] テストが追加されている（カバレッジ80%以上）
- [ ] ドキュメントが更新されている
- [ ] CI/CDが通過している

### 3. レビュー

レビュアーは以下の観点でレビュー：

- **機能性**: 要件を満たしているか
- **コード品質**: 可読性、保守性
- **テスト**: 十分なテストカバレッジ
- **ドキュメント**: 適切なドキュメント
- **パフォーマンス**: パフォーマンスへの影響
- **セキュリティ**: セキュリティリスク

### 4. 承認とマージ

- すべてのレビュアーが承認
- CI/CDが通過
- コンフリクトがない
- 統合エージェント担当者がマージ

## レビュー基準

### 必須項目

#### 1. コードスタイル

- Blackでフォーマットされている
- Ruffのリンターエラーがない
- 命名規則に従っている

#### 2. 型安全性

- mypyの型チェックが通過している
- すべての関数に型ヒントがある

#### 3. テスト

- 単体テストが追加されている
- カバレッジが80%以上
- エッジケースがテストされている

#### 4. エラーハンドリング

- 適切なエラーハンドリングがある
- エラーメッセージが明確
- ロギングが適切

#### 5. ドキュメント

- docstringが記述されている
- エージェントドキュメントが更新されている

### 推奨項目

#### 1. パフォーマンス

- 不要な処理がない
- 適切なキャッシュが使用されている

#### 2. セキュリティ

- 入力検証が適切
- 機密情報がハードコードされていない

#### 3. 再利用性

- 共通処理がユーティリティ化されている
- 重複コードがない

## レビューコメントの書き方

### 良いレビューコメント

- **具体的**: 「この関数は長すぎます」→「この関数は50行を超えているため、分割を検討してください」
- **建設的**: 問題点だけでなく、改善案も提示
- **丁寧**: 批判的ではなく、協力的なトーン

### レビューコメントの例

```python
# ❌ 悪い例
# これは間違っている

# ✅ 良い例
# この関数は長すぎるため、以下のように分割することを検討してください：
# 1. 入力検証を別関数に
# 2. ビジネスロジックを別関数に
```

## よくあるレビュー指摘

### 1. 型ヒントの不足

```python
# ❌ 悪い例
def process_query(query, session_id):
    pass

# ✅ 良い例
def process_query(query: str, session_id: str) -> UnifiedAgentResponse:
    pass
```

### 2. エラーハンドリングの不足

```python
# ❌ 悪い例
result = some_operation()

# ✅ 良い例
try:
    result = some_operation()
except Exception as e:
    logger.error(f"Error in some_operation: {e}", exc_info=True)
    return handle_error(e, agent_name="MyAgent")
```

### 3. ロギングの不足

```python
# ❌ 悪い例
def process_query(query: str):
    # 処理
    return result

# ✅ 良い例
def process_query(query: str):
    logger.info(f"Processing query: {query}")
    # 処理
    logger.info("Query processed successfully")
    return result
```

### 4. テストの不足

```python
# ❌ 悪い例
# テストなし

# ✅ 良い例
def test_process_query():
    result = process_query("営業時間は？", "session-123")
    assert result["routed_to"] == "business_info"
```

## レビュー時間の目安

- **小規模な変更**（< 100行）: 1-2時間以内
- **中規模な変更**（100-500行）: 1日以内
- **大規模な変更**（> 500行）: 2-3日以内

## コンフリクト解決

### コンフリクトが発生した場合

1. 統合エージェント担当者が確認
2. 関係者と協議
3. 解決方針を決定
4. PR作成者または統合エージェント担当者が解決

## 参考

- [開発標準](DEVELOPMENT-STANDARDS.md)
- [ブランチ戦略](BRANCH-STRATEGY.md)
- [統合ガイド](INTEGRATION-GUIDE.md)

